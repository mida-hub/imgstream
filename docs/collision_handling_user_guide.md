# ファイル名衝突処理ユーザーガイド

## 概要

imgstreamでは、同じファイル名の写真をアップロードしようとした際に、既存の写真との衝突を自動的に検出し、ユーザーに適切な選択肢を提供します。

## 衝突検出の仕組み

### 自動検出
- ファイルアップロード時に、同じファイル名の写真が既に存在するかを自動チェック
- バッチアップロード時は、複数ファイルを一括でチェック
- 高速な検出のためのキャッシュ機能を内蔵

### 検出される情報
衝突が検出されると、以下の情報が表示されます：
- **既存ファイルの情報**
  - アップロード日時
  - ファイルサイズ
  - 作成日時（EXIF情報から取得）
- **衝突の詳細**
  - ファイル名
  - 衝突の種類

## ユーザーの選択肢

### 1. 上書きする（Overwrite）
- **動作**: 既存の写真を新しい写真で置き換えます
- **保持される情報**:
  - 元の作成日時
  - 写真ID
  - アップロード履歴
- **更新される情報**:
  - 写真データ
  - ファイルサイズ
  - メタデータ（EXIF情報など）
- **推奨ケース**:
  - 同じ写真の高画質版をアップロードする場合
  - 編集済みの写真で元の写真を更新する場合

### 2. スキップする（Skip）
- **動作**: 既存の写真をそのまま保持し、新しい写真はアップロードしません
- **保持される情報**: すべての既存情報がそのまま保持
- **推奨ケース**:
  - 既存の写真を保持したい場合
  - 異なる写真だが偶然同じファイル名の場合

## 使用方法

### 単一ファイルのアップロード

1. **ファイル選択**: アップロードページでファイルを選択
2. **衝突検出**: 同名ファイルがある場合、警告が表示
3. **選択**: 「上書きする」または「スキップする」を選択
4. **実行**: 「アップロード」ボタンをクリック

### バッチアップロード

1. **複数ファイル選択**: 複数のファイルを一度に選択
2. **一括衝突検出**: すべてのファイルの衝突を一括チェック
3. **個別選択**: 衝突があるファイルごとに選択
4. **混合処理**: 新規アップロード、上書き、スキップが混在可能

## 衝突警告の表示

### 通常モード
```
⚠️ 2 file(s) have filename conflicts

📷 photo1.jpg
既存ファイル情報:
• アップロード日時: 2023-01-01 12:00:00
• ファイルサイズ: 2.5 MB
• 作成日時: 2022-12-31 15:30:00

選択してください: [上書きする] [スキップする]
```

### 安全モード（フォールバック）
```
⚠️ 2 file(s) have filename conflicts (安全モードで検出)

🛡️ 安全モード: 衝突検出システムに問題が発生したため、安全のため
すべてのファイルで既存ファイルの確認を求めています。
実際には衝突していない可能性もあります。

📷 photo1.jpg
⚠️ 安全モードで検出されました
既存ファイル情報: 安全モードのため取得できません
推奨: 上書きを選択する前に既存ファイルを確認してください

選択してください: [上書きする] [スキップする]
```

## アップロード結果の表示

### 成功時の表示

#### 新規アップロード
```
✅ New Uploads (3)
📷 photo1.jpg
   📅 Created: 2023-01-01 12:00:00
   💾 Size: 2.5 MB
   ✅ New Upload
```

#### 上書き完了
```
🔄 Overwrites (2)
以下のファイルは既存の写真を上書きしました:

📷 photo2.jpg
新しいファイル情報:
   📅 撮影日時: 2023-01-02 14:30:00
   💾 ファイルサイズ: 3.1 MB
   ✅ 上書き完了 - 既存の写真が新しいバージョンに置き換えられました

保持された情報:
   🔒 元の作成日時とファイルIDは保持されています
   📊 メタデータは新しいファイルの情報に更新されました
```

#### スキップされたファイル
```
⏭️ スキップされたファイル (1)
以下のファイルはユーザーの選択によりスキップされました:

📷 photo3.jpg
スキップ理由:
   ⚠️ 同名のファイルが既に存在していました
   👤 ユーザーが上書きを選択せず、スキップを選択しました
   🔒 既存のファイルは変更されていません

💡 ヒント: 同じファイルを後でアップロードしたい場合は、
ファイル名を変更するか、上書きを選択してください。
```

## ベストプラクティス

### ファイル名の管理
- **一意性の確保**: 可能な限り一意のファイル名を使用
- **命名規則**: 日付や連番を含む命名規則の採用
- **整理**: 定期的なファイル整理で重複を防止

### 上書き判断の指針
- **同じ写真の場合**: 高画質版や編集版は上書きを推奨
- **異なる写真の場合**: ファイル名を変更してから再アップロード
- **不明な場合**: 既存ファイルの詳細を確認してから判断

### バッチアップロード時の注意
- **事前確認**: 大量ファイルの場合は事前にファイル名を確認
- **段階的アップロード**: 不安な場合は小分けしてアップロード
- **バックアップ**: 重要なファイルは事前にバックアップを作成

## トラブルシューティング

### よくある問題

#### 1. 衝突検出が動作しない
**症状**: 同名ファイルがあるのに衝突が検出されない
**原因**: 
- データベース接続の問題
- キャッシュの問題
**対処法**:
- ページを再読み込み
- ブラウザのキャッシュをクリア
- 管理者に連絡

#### 2. 安全モードが頻繁に発動する
**症状**: 実際には衝突していないのに安全モードになる
**原因**:
- データベースの一時的な問題
- ネットワークの不安定
**対処法**:
- しばらく待ってから再試行
- 個別ファイルでのアップロードを試行
- 管理者に連絡

#### 3. 上書き操作が失敗する
**症状**: 上書きを選択したが操作が失敗する
**原因**:
- ファイルサイズの制限
- 権限の問題
- ストレージの問題
**対処法**:
- ファイルサイズを確認
- ファイル形式を確認
- 管理者に連絡

#### 4. アップロード結果が表示されない
**症状**: アップロード完了後に結果が表示されない
**原因**:
- ブラウザの問題
- セッションの問題
**対処法**:
- ページを再読み込み
- ギャラリーページで結果を確認
- ブラウザを再起動

### エラーメッセージと対処法

#### "衝突検出に失敗しました"
- **対処法**: ページを再読み込みして再試行
- **継続する場合**: 管理者に連絡

#### "上書き操作に失敗しました"
- **対処法**: ファイルサイズと形式を確認
- **継続する場合**: ファイル名を変更して新規アップロード

#### "データベースエラーが発生しました"
- **対処法**: しばらく待ってから再試行
- **継続する場合**: 管理者に連絡

## 技術的な詳細

### 衝突検出の仕組み
1. **ファイル名ベース検出**: アップロード前にファイル名で既存写真を検索
2. **バッチ最適化**: 複数ファイルを効率的に一括検索
3. **キャッシュ機能**: 頻繁にアクセスされる情報をキャッシュ
4. **フォールバック機能**: 検出失敗時の安全モード

### データの保持と更新
- **保持されるデータ**: 写真ID、元の作成日時、アップロード履歴
- **更新されるデータ**: 写真ファイル、メタデータ、ファイルサイズ
- **トランザクション**: データベース操作の整合性を保証

### パフォーマンス最適化
- **並列処理**: 複数ファイルの並列検出
- **インデックス**: データベースインデックスによる高速検索
- **キャッシュ**: メモリキャッシュによる応答速度向上

## サポート

### 問題報告
問題が発生した場合は、以下の情報と共に管理者に連絡してください：
- 発生した操作（アップロード、上書きなど）
- エラーメッセージ
- ファイル名とサイズ
- 発生時刻

### 機能要望
新しい機能や改善要望がある場合は、管理者にお知らせください。

---

このガイドは、imgstreamのファイル名衝突処理機能を効果的に活用するための包括的な情報を提供しています。不明な点がある場合は、管理者にお問い合わせください。
