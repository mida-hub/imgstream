# Requirements Document

## Introduction

現在のアップロード処理では、同名のファイルがアップロードされた際にファイル名衝突が発生し、既存のファイルが自動的に上書きされてしまいます。この機能では、ファイル検証段階で既存ファイルとの衝突を検出し、ユーザーに上書き確認を求める仕組みを実装します。ユーザーが上書きを選択した場合は、データベースでINSERTではなくUPDATEを実行して既存レコードを更新します。

## Requirements

### 要件 1

**ユーザーストーリー:** ユーザーとして、既に存在するファイルをアップロードしようとした時に警告を受け取り、上書きするかどうかを決められるようにしたい。

#### 受け入れ基準

1. ユーザーが既にコレクションに存在するファイル名でファイルをアップロードした時、システムは検証結果セクションに警告を表示する
2. システムがファイル名の衝突を検出した時、既存ファイルのメタデータ（アップロード日時、ファイルサイズ）を表示する
3. ファイル名の衝突が検出された時、システムは上書きして続行するかキャンセルするかの明確な選択肢を提供する
4. システムが衝突警告を表示する時、衝突ファイルと他の検証エラーを区別して表示する

### 要件 2

**ユーザーストーリー:** ユーザーとして、既存ファイルを上書きするかどうかを選択できるようにして、自分の写真コレクションをコントロールしたい。

#### 受け入れ基準

1. ユーザーが衝突警告を見た時、既存ファイルを上書きしてアップロードを続行できる
2. ユーザーが上書きを選択した時、システムは既存ファイルが置き換えられることを明確に示す
3. ユーザーが上書きを選択して続行する時、衝突ファイルに対してもアップロードボタンが機能する
4. ユーザーが上書きをキャンセルした時、システムは衝突ファイルをアップロードバッチから除外する

### 要件 3

**ユーザーストーリー:** システム管理者として、ファイルの上書き時に重複レコードを作成するのではなく既存のデータベースレコードを更新して、データの整合性を維持したい。

#### 受け入れ基準

1. ユーザーが既存ファイルを上書きした時、システムは既存のデータベースレコードに対してUPDATE操作を実行する
2. システムが既存レコードを更新する時、元の作成日時と写真IDを保持する
3. システムが既存レコードを更新する時、アップロード日時、ファイルサイズ、GCSパスを更新する
4. システムがUPDATE操作を実行する時、関連データとの参照整合性を維持する

### 要件 4

**ユーザーストーリー:** ユーザーとして、上書きプロセスがシームレスで信頼性があるようにして、写真管理の体験をスムーズにしたい。

#### 受け入れ基準

1. システムがファイルを上書きする時、GCS内の元画像とサムネイルの両方を置き換える
2. システムが上書きを完了した時、ファイルが更新されたことを示す明確なフィードバックを表示する
3. 上書きが失敗した時、システムは元のファイルを保持し、適切なエラーメッセージを表示する
4. システムが混合バッチを処理する時、新規アップロードと上書きの両方を正しく処理する

### 要件 5

**ユーザーストーリー:** 開発者として、衝突検出が正確でパフォーマンスが良いようにして、システムがスケールできるようにしたい。

#### 受け入れ基準

1. システムが衝突をチェックする時、user_idとfilenameでデータベースをクエリする
2. システムが衝突を検出する時、アップロード処理前の検証フェーズで実行する
3. システムが大きなバッチを処理する時、衝突検出がパフォーマンスに大きな影響を与えない
4. システムが衝突イベントをログに記録する時、監視とデバッグに十分な詳細を含める
