# 実装計画

- [x] 1. MetadataService に衝突検出機能を追加

  - ファイル名で既存写真をクエリする`check_filename_exists()`メソッドを追加
  - ファイル名衝突検出のための効率的なデータベースクエリを実装
  - 衝突検出イベントのログ記録を追加
  - 衝突検出機能のユニットテストを作成
  - _要件: 1.1, 5.1, 5.2_

- [x] 2. 衝突検出ユーティリティを作成

  - バッチ衝突検出のための`check_filename_collisions()`関数を実装
  - 衝突情報保存のためのデータ構造を作成
  - 衝突結果処理のためのヘルパー関数を追加
  - 衝突ユーティリティのユニットテストを作成
  - _要件: 1.1, 1.2, 5.1_

- [x] 3. ファイル検証に衝突検出を統合

  - `validate_uploaded_files()`を修正して衝突チェックを含める
  - `validate_uploaded_files_with_collision_check()`関数を作成
  - 検証フローに衝突検出を統合
  - 衝突情報を含むように検証結果データ構造を更新
  - 拡張された検証のユニットテストを作成
  - _要件: 1.1, 1.2, 1.3, 5.2_

- [x] 4. 衝突警告 UI コンポーネントを実装

  - 警告表示のための`render_collision_warnings()`関数を作成
  - 検証結果での衝突警告の UI レイアウトを設計
  - 既存ファイル情報表示（アップロード日時、ファイルサイズ）を追加
  - ユーザー決定収集インターフェース（上書き/スキップオプション）を実装
  - UI コンポーネントのユニットテストを作成
  - _要件: 1.2, 1.3, 2.1, 2.2_

- [x] 5. アップロードページに衝突処理を追加

  - 衝突追跡のためのセッション状態変数を追加
  - ファイル検証フローに衝突検出を統合
  - ユーザー決定の収集と保存を実装
  - 上書き確認を処理するようにアップロードボタンロジックを更新
  - 検証結果表示に衝突警告を追加
  - アップロードページ衝突フローの統合テストを作成
  - _要件: 1.1, 1.2, 2.1, 2.2, 2.3_

- [x] 6. 上書き用のデータベース UPDATE 操作を実装

  - MetadataService に`update_photo_metadata()`メソッドを追加
  - INSERT と UPDATE の両方をサポートするように`save_photo_metadata()`を修正
  - 元の作成日時と写真 ID を保持するロジックを実装
  - UPDATE 操作の適切なトランザクション処理を追加
  - データベース UPDATE 操作のユニットテストを作成
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [x] 7. 上書き操作のためのアップロード処理を拡張

  - 上書きモードを処理するように`process_single_upload()`を修正
  - 新規/上書き混合操作のために`process_batch_upload()`を更新
  - 上書き失敗の適切なエラーハンドリングを実装
  - 上書き操作のログ記録を追加
  - 拡張されたアップロード処理のユニットテストを作成
  - _要件: 3.1, 4.1, 4.2, 4.3_

- [x] 8. 上書き用のアップロード結果表示を更新

  - 新規アップロードと上書きを区別するように`render_upload_results()`を修正
  - 成功した上書き操作の明確なフィードバックを追加
  - 上書き失敗のエラーハンドリング表示を更新
  - 混合バッチ結果の適切なメッセージングを実装
  - 結果表示のユニットテストを作成
  - _要件: 4.2, 4.3_

- [ ] 9. 包括的なエラーハンドリングを追加

  - 衝突検出失敗のエラー回復を実装
  - 上書き操作失敗の適切なエラーハンドリングを追加
  - データベース UPDATE 失敗のフォールバック動作を作成
  - 衝突関連エラーのユーザーフレンドリーなエラーメッセージを追加
  - エラーハンドリングシナリオのユニットテストを作成
  - _要件: 4.3, 4.4_

- [ ] 10. パフォーマンス最適化を実装

  - 衝突検出のデータベースクエリを最適化
  - 効率的なバッチ衝突検出を追加
  - 衝突チェックの適切なキャッシュを実装
  - 衝突検出操作のパフォーマンス監視を追加
  - 衝突検出のパフォーマンステストを作成
  - _要件: 5.3, 5.4_

- [ ] 11. 包括的なログ記録と監視を追加

  - すべての衝突検出イベントのログ記録を実装
  - 上書き操作のメトリクス追跡を追加
  - ユーザー決定パターンの監視を作成
  - 衝突検出のパフォーマンスログ記録を追加
  - ログ記録機能のテストを作成
  - _要件: 1.4, 5.4_

- [ ] 12. 完全フローの統合テストを作成

  - 衝突検出と上書きフローのエンドツーエンドテストを作成
  - 新規ファイルと上書きの混合バッチアップロードをテスト
  - エラー回復シナリオのテストを追加
  - 上書き操作中のデータベース整合性をテスト
  - 既存写真との後方互換性を検証
  - _要件: 4.1, 4.2, 4.3, 4.4_

- [ ] 13. データベースリセット機能を追加

  - MetadataService に`force_reload_from_gcs()`メソッドを追加
  - ローカル DuckDB ファイルを削除して GCS から再ダウンロードする機能を実装
  - 開発/テスト用のデータベースリセットエンドポイントを追加
  - リセット操作のログ記録と安全性チェックを実装
  - データベースリセット機能のユニットテストを作成
  - _要件: 開発・テスト支援機能_

- [ ] 14. ドキュメントとユーザーガイダンスを更新
  - 衝突処理のユーザードキュメントを追加
  - 新しいメソッドの API ドキュメントを更新
  - 衝突関連問題のトラブルシューティングガイドを作成
  - データベースリセット機能の使用方法を文書化
  - 新しい衝突検出ロジックのコードコメントを追加
  - _要件: 2.1, 2.2, 2.3_
