# 設計書

## 概要

既存のサムネイル変換処理を流用して、HEIC写真の詳細表示時にJPEG変換を行い、Webブラウザで表示可能にします。キャッシュ機能は実装せず、シンプルなオンデマンド変換で対応します。

## アーキテクチャ

### 高レベルフロー
1. ユーザーがギャラリーでHEIC写真のサムネイルをクリック
2. ギャラリーがHEICファイルかどうかを判定
3. HEICの場合、画像プロセッサで高品質JPEG変換を実行
4. 変換されたJPEGデータを直接ブラウザに表示

### コンポーネント間の相互作用
```
Gallery UI → Image Processor → JPEG Data → Browser Display
```

## コンポーネントとインターフェース

### 1. 拡張画像プロセッサ

**新しいメソッド:**
- `convert_to_web_display_jpeg(image_data: bytes, quality: int = 90) -> bytes`

**責任:**
- 既存のサムネイル変換ロジックを流用
- HEIC画像を高品質JPEG（品質90）に変換
- アスペクト比を維持（元サイズで変換）
- 変換エラーを適切に処理

### 2. 拡張ギャラリーUI

**変更された関数:**
- `get_photo_original_url()` - HEICファイルの場合は変換処理を呼び出し
- `render_photo_detail_image()` - HEIC変換とエラーハンドリングを追加

**責任:**
- ファイル拡張子でHEICファイルを検出
- HEIC変換処理を実行
- 変換失敗時はサムネイル表示にフォールバック

## エラーハンドリング

### 変換失敗時の対応
1. **変換エラー**: サムネイル表示 + エラーメッセージ
2. **ファイル読み込み失敗**: 汎用エラー状態を表示

### フォールバック戦略
```
HEIC Photo Display Request
    ↓
Convert HEIC to JPEG
    ↓ (変換成功)
Display JPEG in Browser
    ↓ (変換失敗)
Display Thumbnail + Error Message
```

## テスト戦略

### 単体テスト
- HEIC to JPEG変換機能
- エラーハンドリング（変換失敗）
- ファイル形式判定ロジック
- 品質設定とアスペクト比保持

## 実装上の考慮事項

### 既存コードの流用
- `generate_thumbnail()`メソッドのロジックを参考
- PIL/Pillowの変換処理を再利用
- 既存のエラーハンドリングパターンを踏襲

### パフォーマンス
- 変換は詳細表示時のみ実行（遅延実行）
- メモリ効率を考慮した処理
- 変換時間の監視とログ出力

### セキュリティ
- 入力ファイルの検証
- 適切なエラーメッセージ表示
- リソース使用量の制限
