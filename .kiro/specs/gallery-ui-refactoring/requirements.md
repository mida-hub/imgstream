# 要件定義書

## 概要

ギャラリー機能のユーザビリティ向上とコードの保守性改善を目的として、UIコンポーネントの分離とモーダル表示機能を実装する。現在のギャラリーページは単一ファイルに全機能が集約されており、コードの可読性と再利用性に課題がある。また、画像の詳細表示がページ遷移ベースで、ユーザー体験が最適化されていない。

## 要件

### 要件1

**ユーザーストーリー:** 開発者として、ギャラリー機能を適切にコンポーネント、ハンドラー、ページに分離したい。これにより、コードの保守性とテスト性を向上させたい。

#### 受け入れ基準

1. ギャラリーコードが整理される時、システムは3つの異なる層に関心事を分離する必要がある：
   - `ui/components/gallery.py` - UI描画コンポーネント用
   - `ui/handlers/gallery.py` - ビジネスロジックとデータ処理用
   - `ui/pages/gallery.py` - ページオーケストレーション用
2. コンポーネントが作成される時、各コンポーネントは単一の責任を持つ必要がある
3. ハンドラーが実装される時、UI描画ロジックを含んではならない
4. ページが構造化される時、コンポーネントとハンドラーのオーケストレーションのみを行う必要がある

### 要件2

**ユーザーストーリー:** ユーザーとして、写真の詳細をモーダルダイアログで表示したい。これにより、ギャラリー内の位置を失うことなく、大きな画像とメタデータを確認できるようにしたい。

#### 受け入れ基準

1. 写真のサムネイルをクリックした時、システムはst.dialogを使用してモーダルダイアログを開く必要がある
2. モーダルが開いた時、左側にフルサイズの画像を表示する必要がある
3. モーダルが開いた時、右側に写真のメタデータとアクションを表示する必要がある
4. モーダルを閉じた時、ギャラリー内の同じ位置に戻る必要がある
5. HEIC画像を表示する時、システムはWeb表示用にJPEGに変換する必要がある
6. HEIC変換が失敗した場合、システムはサムネイルをフォールバックとして表示する必要がある

### 要件3

**ユーザーストーリー:** ユーザーとして、拡張された写真表示機能を利用したい。これにより、HEICファイルを含む異なる画像形式を適切に表示できるようにしたい。

#### 受け入れ基準

1. HEIC画像を表示する時、システムはJPEG形式に変換する必要がある
2. HEIC変換が進行中の時、システムはローディングインジケーターを表示する必要がある
3. HEIC変換が失敗した時、システムはエラーメッセージを表示し、サムネイルにフォールバックする必要がある
4. HEIC以外の画像を表示する時、システムは元の画像URLを使用する必要がある
5. 画像の読み込みが失敗した時、システムは情報的なエラーメッセージを提供する必要がある

### 要件4

**ユーザーストーリー:** ユーザーとして、改善された写真メタデータ表示を利用したい。これにより、写真がいつ撮影され、アップロードされたかをより良く理解できるようにしたい。

#### 受け入れ基準

1. 作成日を表示する時、システムはJSTタイムゾーンで表示する必要がある
2. 作成日がアップロード日と等しい時、システムはEXIFデータがないと仮定し、UTCからJSTに変換する必要がある
3. 作成日がアップロード日と異なる時、システムは作成日をそのまま表示する必要がある（EXIFデータがあると仮定）
4. ファイルサイズを表示する時、システムはMB形式で表示する必要がある
5. メタデータが欠落している時、システムはフォールバック値で適切に処理する必要がある

### 要件5

**ユーザーストーリー:** ユーザーとして、オリジナル写真のダウンロード機能を利用したい。これにより、高品質版をローカルに保存できるようにしたい。

#### 受け入れ基準

1. ダウンロードボタンをクリックした時、システムはオリジナル写真の署名付きURLを生成する必要がある
2. ダウンロードリンクが準備できた時、システムは明確な指示と共にそれを表示する必要がある
3. ダウンロードが失敗した時、システムは適切なエラーメッセージを表示する必要がある
4. 署名付きURLが期限切れになる時、少なくとも1時間は有効である必要がある

### 要件6

**ユーザーストーリー:** 開発者として、適切なキャッシュ戦略を実装したい。これにより、大きな写真コレクションでもアプリケーションが良好に動作するようにしたい。

#### 受け入れ基準

1. 写真リストを読み込む時、システムは結果を5分間キャッシュする必要がある
2. 署名付きURLを生成する時、システムはそれらを50分間キャッシュする必要がある
3. HEIC画像を変換する時、システムは変換されたデータを24時間キャッシュする必要がある
4. キャッシュを無効化する必要がある時、システムはrerun_counterメカニズムを提供する必要がある
5. キャッシュが失敗した時、システムはキャッシュなしで機能し続ける必要がある

### 要件7

**ユーザーストーリー:** ユーザーとして、一貫したエラーハンドリングとユーザーフィードバックを受けたい。これにより、問題が発生した時に何が起こっているかを理解できるようにしたい。

#### 受け入れ基準

1. エラーが発生した時、システムは適切なコンテキストでそれらをログに記録する必要がある
2. ユーザーにエラーを表示する時、メッセージは日本語でユーザーフレンドリーである必要がある
3. 操作が進行中の時、システムはローディングインジケーターを表示する必要がある
4. 操作が正常に完了した時、システムは確認フィードバックを提供する必要がある
5. フォールバックオプションが存在する時、システムは自動的にそれらを使用する必要がある
