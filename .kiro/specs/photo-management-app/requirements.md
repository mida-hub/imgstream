# 要件定義書

## はじめに

この機能は、スマートフォンで撮影した写真・動画をアップロードし、Google Cloud Storage（GCS）に安全に保存し、軽量なサムネイルベースのインターフェースで閲覧できる個人向け写真管理 Web アプリケーションを実装します。このシステムは個人利用を想定しており、Cloud IAP 認証を使用し、フロントエンドには Streamlit、メタデータ管理には DuckDB を使用します。

## 要件

### 要件 1

**ユーザーストーリー:** ユーザーとして、Cloud IAP を通じて安全に認証し、自分の個人的な写真コレクションにのみアクセスできるようにしたい。

#### 受け入れ基準

1. ユーザーがアプリケーションにアクセスする時、システムは Cloud IAP を通じて認証を行うものとする
2. 認証が成功した時、システムはユーザー固有の写真データへのアクセスを提供するものとする
3. 認証が失敗した時、システムはアプリケーションへのアクセスを拒否するものとする
4. ユーザーが認証された場合、システムはそのユーザーの写真とデータベースを他のユーザーから分離するものとする

### 要件 2

**ユーザーストーリー:** ユーザーとして、iPhone の写真（HEIC、JPEG）を Web ブラウザからアップロードし、クラウドに安全に保存したい。

#### 受け入れ基準

1. ユーザーがアップロード用に写真を選択する時、システムは HEIC および JPEG 形式を受け入れるものとする
2. 写真がアップロードされた時、システムは EXIF データから作成日を抽出するものとする
3. アップロード処理が開始された時、システムはオリジナル画像を GCS Standard Storage に保存するものとする
4. オリジナルが保存された時、システムは低解像度のサムネイルを生成するものとする
5. サムネイル生成が完了した時、システムはサムネイルを別の GCS パスに保存するものとする
6. すべての処理が完了した時、システムはファイル名、作成日、アップロード日、サムネイルパスを含むメタデータを DuckDB に記録するものとする

### 要件 3

**ユーザーストーリー:** ユーザーとして、写真のメタデータを個人データベースで効率的に管理し、GCS に直接クエリを実行せずに高速に閲覧できるようにしたい。

#### 受け入れ基準

1. アプリケーションが起動する時、システムはユーザーごとに 1 つの DuckDB ファイル（metadata.db）を作成するものとする
2. Cloud Run が起動する時、システムはユーザーの DuckDB ファイルを GCS から/tmp/にダウンロードするものとする
3. メタデータが更新された時、システムはローカルの DuckDB ファイルに変更を書き込むものとする
4. データベースの書き込みが完了した時、システムは更新された DuckDB ファイルを非同期で GCS にアップロードするものとする
5. DuckDB ファイルが存在しない場合、システムは写真テーブルスキーマを持つ新しいファイルを作成するものとする

### 要件 4

**ユーザーストーリー:** ユーザーとして、高速に読み込まれるサムネイルを通じて時系列順に写真を閲覧し、特定の画像をすばやく見つけて表示したい。

#### 受け入れ基準

1. メインページが読み込まれる時、システムは作成日順（最新順）にソートされたサムネイルを表示するものとする
2. サムネイルを表示する時、システムは最初に最新の N 枚の写真を表示するものとする
3. ユーザーがサムネイルをクリックする時、システムはオリジナル画像を表示するか、詳細ビューに移動するものとする
4. 写真データを照会する時、システムは GCS オブジェクトリストではなく、DuckDB メタデータのみを使用するものとする
5. 写真がない場合、システムは適切な空の状態メッセージを表示するものとする

### 要件 5

**ユーザーストーリー:** ユーザーとして、自分の写真を自動ライフサイクル管理によってコスト効率よく保存し、長期間にわたってストレージコストを最小限に抑えたい。

#### 受け入れ基準

1. オリジナル写真がアップロードされる時、システムはそれらを GCS Standard Storage クラスに保存するものとする
2. 30 日が経過した時、システムは自動的にオリジナル写真を Coldline ストレージクラスに移行するものとする
3. サムネイルが作成される時、システムはそれらを永続的に GCS Standard Storage クラスに保存するものとする
4. DuckDB ファイルが保存される時、システムはそれらを GCS Standard Storage クラスに保存するものとする
5. ライフサイクルルールが設定されている場合、システムは手動介入なしに自動的にそれらを適用するものとする

### 要件 6

**ユーザーストーリー:** システム管理者として、インフラストラクチャを Terraform で管理し、デプロイメントとメンテナンスを自動化して再現可能にしたい。

#### 受け入れ基準

1. システムをデプロイする時、すべての GCP リソースは Terraform 設定で定義されるものとする
2. インフラストラクチャの変更が必要な時、それらは Terraform を通じて適用されるものとする
3. システムがデプロイされる時、適切なスケーリング設定で Cloud Run 上で実行されるものとする
4. GCS バケットが作成される時、適切なライフサイクルポリシーとアクセス制御が設定されるものとする
5. システムを複製する必要がある場合、Terraform は環境間で一貫したデプロイメントを可能にするものとする

### 要件 7

**ユーザーストーリー:** ユーザーとして、アプリケーションが GCP 無料枠の制限内で効率的に動作し、個人的な写真ストレージがコスト効率よく維持されるようにしたい。

#### 受け入れ基準

1. システムが動作する時、無料枠の制限内に収まるように GCP リソースの使用を最小限に抑えるものとする
2. Cloud Run インスタンスが起動する時、最小限の CPU とメモリ構成を使用するものとする
3. データを保存する時、システムは適切なストレージクラスを通じてコストを最適化するものとする
4. 写真を処理する時、システムは計算時間を最小限に抑えるために効率的なアルゴリズムを使用するものとする
5. 使用量が無料枠の制限に近づいた場合、システムは予期しないコストなしで動作し続けるものとする
