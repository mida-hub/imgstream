# 実装計画

## 概要

この実装計画は、個人向け写真管理 Web アプリケーション「imgstream」の開発タスクを段階的に定義します。各タスクはテスト駆動開発を重視し、段階的な機能構築を通じて要件を満たすことを目指します。

## タスクリスト

- [ ] 1. プロジェクト基盤の構築

  - uv を使用した Python プロジェクトの初期化
  - 基本的なディレクトリ構造とパッケージ設定の作成
  - 開発環境の構築と CI/CD 基盤の準備
  - _要件: 6.1, 6.2, 6.5_

- [x] 1.1 uv プロジェクトの初期化とディレクトリ構造作成

  - pyproject.toml ファイルの作成と依存関係の定義
  - src/imgstream/ディレクトリ構造の作成
  - 基本的な**init**.py ファイルの配置
  - _要件: 6.1, 6.2_

- [x] 1.2 開発用依存関係とツール設定

  - pytest、black、ruff、mypy の設定
  - pre-commit フックの設定
  - 基本的なテスト構造の作成
  - _要件: 6.1, 6.2_

- [ ] 1.3 Dockerfile とコンテナ設定

  - uv を使用したマルチステージ Dockerfile の作成
  - 必要なシステム依存関係（libheif1）の設定
  - ローカル開発用 docker-compose.yml の作成
  - _要件: 6.3, 7.2_

- [ ] 2. データモデルとスキーマの実装

  - DuckDB スキーマの定義と作成
  - PhotoMetadata データクラスの実装
  - データベース初期化機能の実装
  - _要件: 3.1, 3.5_

- [ ] 2.1 PhotoMetadata データクラスの実装

  - dataclass を使用した PhotoMetadata クラスの作成
  - 型ヒントとバリデーション機能の実装
  - 単体テストの作成
  - _要件: 3.1, 3.5_

- [ ] 2.2 DuckDB スキーマとテーブル作成機能

  - photos テーブルの CREATE 文実装
  - インデックス作成機能の実装
  - データベース初期化関数の作成とテスト
  - _要件: 3.1, 3.5_

- [ ] 3. 認証サービス（AuthService）の実装

  - Cloud IAP ヘッダーからのユーザー識別機能
  - ユーザー固有パス生成機能
  - 認証状態チェック機能
  - _要件: 1.1, 1.2, 1.4_

- [ ] 3.1 Cloud IAP ヘッダー解析機能の実装

  - X-Goog-IAP-JWT-Assertion ヘッダーの解析
  - JWT トークンからユーザー ID 抽出機能
  - エラーハンドリングと例外処理の実装
  - _要件: 1.1, 1.2_

- [ ] 3.2 ユーザー認証とアクセス制御機能

  - 認証状態確認機能の実装
  - ユーザー固有ストレージパス生成機能
  - アクセス権限チェック機能の実装
  - _要件: 1.2, 1.4_

- [ ] 3.3 認証サービスの単体テスト

  - 正常系・異常系のテストケース作成
  - モックを使用した Cloud IAP ヘッダーテスト
  - エラーハンドリングのテスト
  - _要件: 1.1, 1.2, 1.3, 1.4_

- [ ] 4. 画像処理サービス（ImageProcessor）の実装

  - EXIF 情報抽出機能
  - サムネイル生成機能
  - サポート形式チェック機能
  - _要件: 2.2, 2.4_

- [ ] 4.1 EXIF 情報抽出機能の実装

  - Pillow を使用した EXIF 読み取り機能
  - HEIC 形式対応（pillow-heif 使用）
  - 撮影日時の優先順位付き抽出機能
  - _要件: 2.2_

- [ ] 4.2 サムネイル生成機能の実装

  - 300x300 ピクセルサムネイル生成機能
  - アスペクト比維持機能
  - 画質最適化とファイルサイズ制御
  - _要件: 2.4_

- [ ] 4.3 画像形式サポートとバリデーション

  - HEIC/JPEG 形式チェック機能
  - ファイルサイズ制限チェック
  - 画像処理エラーハンドリング
  - _要件: 2.1, 2.2_

- [ ] 4.4 画像処理サービスの単体テスト

  - 各種画像形式でのテストケース作成
  - EXIF 情報抽出のテスト
  - サムネイル生成品質のテスト
  - _要件: 2.1, 2.2, 2.4_

- [ ] 5. ストレージサービス（StorageService）の実装

  - GCS クライアント設定
  - ファイルアップロード機能
  - 署名付き URL 生成機能
  - _要件: 2.3, 2.5, 4.3_

- [ ] 5.1 GCS クライアントとバケット設定

  - Google Cloud Storage クライアントの初期化
  - バケット構成（original/thumbs）の実装
  - 認証とアクセス権限の設定
  - _要件: 2.3, 2.5_

- [ ] 5.2 オリジナル画像アップロード機能

  - ユーザー固有パスでのファイル保存
  - Standard Storage クラスでの保存
  - アップロード進捗とエラーハンドリング
  - _要件: 2.3_

- [ ] 5.3 サムネイル画像アップロード機能

  - サムネイル専用パスでの保存
  - 効率的なバイナリデータ処理
  - 重複チェックと上書き処理
  - _要件: 2.5_

- [ ] 5.4 署名付き URL 生成とファイルアクセス

  - 安全な画像表示用 URL 生成
  - 有効期限付きアクセス制御
  - ユーザー権限チェック統合
  - _要件: 4.3_

- [ ] 5.5 ストレージサービスの単体テスト

  - GCS アップロード機能のテスト
  - 署名付き URL 生成のテスト
  - エラーハンドリングのテスト
  - _要件: 2.3, 2.5, 4.3_

- [ ] 6. メタデータサービス（MetadataService）の実装

  - DuckDB 接続と操作機能
  - メタデータ CRUD 操作
  - GCS 同期機能
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ] 6.1 DuckDB ファイル管理機能

  - ユーザー固有 DB ファイルの作成
  - GCS からのダウンロード機能
  - ローカルファイル管理機能
  - _要件: 3.1, 3.2_

- [ ] 6.2 写真メタデータ CRUD 操作

  - メタデータ保存機能の実装
  - 作成日順での検索機能
  - ページネーション対応
  - _要件: 3.3, 4.1, 4.2_

- [ ] 6.3 非同期 GCS 同期機能

  - DuckDB ファイルの GCS バックアップ
  - 非同期アップロード処理
  - 同期エラーハンドリング
  - _要件: 3.4_

- [ ] 6.4 メタデータサービスの単体テスト

  - CRUD 操作のテスト
  - 同期機能のテスト
  - エラーハンドリングのテスト
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ] 7. Streamlit フロントエンドの基本実装

  - メインページの作成
  - 認証統合
  - 基本的な UI 構造
  - _要件: 1.1, 1.2, 4.5_

- [ ] 7.1 Streamlit アプリケーション初期化

  - main.py ファイルの作成
  - 基本的なページ構造の実装
  - セッション状態管理の設定
  - _要件: 1.1, 1.2_

- [ ] 7.2 認証機能の統合

  - AuthService との統合
  - 認証失敗時の処理
  - ユーザー情報表示機能
  - _要件: 1.1, 1.2, 1.3_

- [ ] 7.3 基本的なナビゲーションとレイアウト

  - サイドバーとメインエリアの構成
  - 空の状態メッセージの実装
  - エラーメッセージ表示機能
  - _要件: 4.5_

- [ ] 8. 写真アップロード機能の実装

  - ファイル選択 UI
  - アップロード処理
  - 進捗表示
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [ ] 8.1 ファイル選択とバリデーション

  - Streamlit ファイルアップローダーの実装
  - HEIC/JPEG 形式チェック
  - ファイルサイズ制限の実装
  - _要件: 2.1_

- [ ] 8.2 アップロード処理パイプライン

  - 画像処理サービスとの統合
  - ストレージサービスとの統合
  - メタデータサービスとの統合
  - _要件: 2.2, 2.3, 2.4, 2.5, 2.6_

- [ ] 8.3 アップロード進捗とフィードバック

  - 処理状況の表示
  - 成功・失敗メッセージ
  - エラー詳細の表示
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [ ] 9. 写真一覧表示機能の実装

  - サムネイル表示
  - 時系列ソート
  - ページネーション
  - _要件: 4.1, 4.2, 4.4_

- [ ] 9.1 サムネイル一覧表示

  - グリッドレイアウトでのサムネイル表示
  - 署名付き URL を使用した画像表示
  - 作成日時順でのソート機能
  - _要件: 4.1, 4.4_

- [ ] 9.2 ページネーションと遅延読み込み

  - 初期 50 枚の表示制限
  - 追加読み込み機能
  - パフォーマンス最適化
  - _要件: 4.2_

- [ ] 9.3 写真詳細表示機能

  - サムネイルクリック時の詳細表示
  - オリジナル画像の表示
  - メタデータ情報の表示
  - _要件: 4.3_

- [ ] 10. エラーハンドリングとログ機能

  - 構造化ログの実装
  - エラー分類と処理
  - ユーザーフレンドリーなエラーメッセージ
  - _要件: 1.3, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [ ] 10.1 構造化ログシステムの実装

  - structlog を使用したログ設定
  - 各サービスでのログ統合
  - ログレベルとフォーマット設定
  - _要件: 全要件のエラーハンドリング_

- [ ] 10.2 エラー分類と処理機能

  - 認証エラーの処理
  - アップロードエラーの処理
  - データベースエラーの処理
  - 画像処理エラーの処理
  - _要件: 1.3, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [ ] 11. Terraform インフラ構築

  - GCP リソース定義
  - ライフサイクルポリシー設定
  - Cloud IAP 設定
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 11.1 GCS バケットとライフサイクルポリシー

  - 写真保存用バケットの作成
  - Standard→Coldline 移行ポリシー
  - アクセス権限とセキュリティ設定
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 11.2 Cloud Run サービス設定

  - コンテナデプロイ設定
  - 最小リソース構成（無料枠対応）
  - 環境変数とシークレット管理
  - _要件: 6.3, 7.1, 7.2_

- [ ] 11.3 Cloud IAP 認証設定

  - OAuth 設定とドメイン制限
  - アクセス制御ポリシー
  - セキュリティヘッダー設定
  - _要件: 6.1, 6.2, 6.4_

- [ ] 12. CI/CD パイプライン構築

  - GitHub Actions ワークフロー
  - 自動テストとデプロイ
  - セキュリティスキャン
  - _要件: 6.1, 6.2, 6.5_

- [ ] 12.1 テストとリンティングワークフロー

  - uv を使用したテスト実行
  - コード品質チェック（ruff、black、mypy）
  - セキュリティスキャンの統合
  - _要件: 6.1, 6.2_

- [ ] 12.2 ビルドとデプロイワークフロー

  - Docker イメージビルド
  - Cloud Run への自動デプロイ
  - ヘルスチェックと検証
  - _要件: 6.2, 6.3, 6.5_

- [ ] 13. 統合テストと最終検証

  - エンドツーエンドテスト
  - パフォーマンステスト
  - セキュリティテスト
  - _要件: 全要件の統合検証_

- [ ] 13.1 エンドツーエンドテストの実装

  - 認証からアップロードまでの完全フロー
  - 複数ユーザーでのデータ分離テスト
  - エラーシナリオのテスト
  - _要件: 1.1, 1.2, 1.4, 2.1-2.6, 4.1-4.5_

- [ ] 13.2 パフォーマンスと負荷テスト

  - 大量ファイルアップロードテスト
  - 同時アクセステスト
  - メモリ使用量とレスポンス時間測定
  - _要件: 7.1, 7.2, 7.4_

- [ ] 13.3 セキュリティとアクセス制御テスト

  - 認証バイパステスト
  - ユーザー間データアクセステスト
  - 署名付き URL 有効性テスト
  - _要件: 1.1, 1.2, 1.3, 1.4_

- [ ] 14. 本番デプロイと運用準備

  - 本番環境設定
  - 監視とアラート設定
  - ドキュメント作成
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5, 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 14.1 本番環境の構築とデプロイ

  - 本番用 Terraform 設定の適用
  - 環境変数とシークレットの設定
  - 初回デプロイとヘルスチェック
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 14.2 監視とアラート設定

  - Cloud Run メトリクス監視
  - GCS 使用量監視
  - エラー率とレスポンス時間アラート
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 14.3 運用ドキュメントと README 作成
  - セットアップ手順書
  - トラブルシューティングガイド
  - API 仕様書とアーキテクチャ図
  - _要件: 6.5_

## 実装の注意点

### テスト駆動開発

- 各機能実装前に対応するテストケースを作成
- 単体テスト、統合テスト、エンドツーエンドテストの段階的実装
- テストカバレッジ 80%以上を目標

### 段階的実装

- 各タスクは独立して実行可能な単位で設計
- 前のタスクの完了を前提とした依存関係の明確化
- 早期の動作確認とフィードバック収集

### セキュリティファースト

- 認証・認可機能を最優先で実装
- ユーザーデータの分離を全レイヤーで徹底
- セキュリティテストを各段階で実施

### パフォーマンス考慮

- GCP 無料枠内での動作を常に意識
- メモリ使用量と CPU 使用率の最適化
- 大容量ファイル処理の効率化

この実装計画により、要件定義書で定義されたすべての機能要件と非機能要件を満たす、堅牢で拡張可能な写真管理アプリケーションを構築できます。
